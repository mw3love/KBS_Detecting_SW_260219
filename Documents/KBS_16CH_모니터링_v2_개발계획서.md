# KBS 16채널 비디오 모니터링 시스템 v2 - 종합 개발 계획서

---

## 📌 이 문서의 용도

이 문서는 **Claude Code에서 소프트웨어를 구현할 때 사용하는 계획서**입니다.
각 페이즈별로 순차적으로 개발하며, 토큰 소진 시 중단된 구간부터 재개할 수 있도록 설계되었습니다.

---

## 1. 프로젝트 개요

### 목적
KBS 방송 운영을 위한 16채널 비디오 모니터링 시스템 개발

### 입력 환경
- SDI → USB 캡처 카드 (HD 신호, 1920×1080)
- **단일 비디오 소스**: 16분할 멀티뷰 화면 1개 (오디오 임베디드)
- 각 채널 왼쪽에 반투명 초록색 오디오 레벨미터가 이미 포함된 영상

### 감지 대상 (총 34개 감시 포인트)
| 구분 | 대상 | 개수 | 방식 |
|------|------|------|------|
| 영상 블랙 감지 | CH1~CH16 | 16개 | 픽셀 밝기 분석 |
| 영상 스틸 감지 | CH1~CH16 | 16개 | 프레임 차이 비교 |
| 오디오 레벨미터 감지 | CH1~CH16 각 레벨바 | 16개 (Phase 3) | HSV 색상 감지 |
| 실제 임베디드 오디오 감지 | 임베디드 오디오 1채널 | 2개 (Phase 3) | sounddevice 레벨 분석 |

### 1차 개발 범위
- 영상 입력 + 메인 화면 레이아웃
- 감지영역 설정 (홈화면 편집 모드 + 전체화면 모드) + 블랙/스틸 감지
- 오디오 레벨미터 감지 + 실제 임베디드 오디오 모니터링
- 설정 저장/불러오기 + 시각/소리 알림

### 2차 개발 범위 (별도 진행)
- 블랙박스 녹화 (사고 전후 30초)
- 카카오톡 알림

---

## 2. 기술 스택

| 항목 | 선택 | 이유 |
|------|------|------|
| GUI 프레임워크 | PySide6 | 상업적 사용 가능, 전문적 UI |
| 비디오 처리 | OpenCV (cv2) | 캡처 + 프레임 분석 |
| 오디오 처리 | sounddevice | 임베디드 오디오 모니터링 |
| 설정 저장 | JSON | 간단하고 사람이 읽을 수 있음 |
| 로깅 | logging 모듈 | Python 내장 |

### 의존성
```bash
pip install PySide6 opencv-python sounddevice numpy
```

---

## 3. 홈 화면 레이아웃

### 전체 구조 (3분할)
```
┌──────────────────────────────────────────────────────────────────────────┐
│ [상단 바]                                                                │
│ Monitoring Active ⊙  19:38:03  🔊━━●━━  L▓▓░  R▓▓░                    │
│                          V16 A16 EA  👁 🔔[━●━] 📁 🌙 ⚙️                │
├─────────────────────────────────────────────┬────────────────────────────┤
│                                             │  SYSTEM LOG           ● ● │
│                                             │                          │
│                                             │  19:33:57                │
│                                             │  SYSTEM - 프로그램 시작    │
│     [비디오 영역 ~75%]                        │                          │
│                                             │  19:34:07                │
│     16분할 멀티뷰 영상                        │  SYSTEM - 연결 실패       │
│     (NO SIGNAL INPUT 표시 가능)              │  (빨간 배경)              │
│                                             │                          │
│     감지영역: 빨간 굵은 테두리               │  19:25:01                │
│     이상 발생 시 해당 영역 빨간 깜빡임        │  NETWORK - Latency OK    │
│     (정상 시 아무 표시 없음)                  │                          │
│                                             │  (세로 스크롤)            │
│                                             │                          │
└─────────────────────────────────────────────┴────────────────────────────┘
```

### 상단 바 구성 (왼쪽→오른쪽)

| 순서 | 요소 | 설명 |
|------|------|------|
| 1 | **Monitoring Active** | 토글 스위치 (감시 ON/OFF) |
| 2 | **현재 시각** | HH:MM:SS (큰 글씨) |
| 3 | **오디오** | 스피커 아이콘(뮤트 토글) + 볼륨 슬라이더 + L/R 실제 임베디드 오디오 레벨미터 |
| 4 | **감지현황** | `V16 A16 EA` 형태 (V=영상, A=오디오레벨미터, EA=임베디드오디오) |
| 5 | **감지영역 보이기** | 👁 눈 아이콘 (감지영역 오버레이 ON/OFF) |
| 6 | **소리 알람** | 🔔 종 아이콘(알람 ON/OFF) + 알람 볼륨 슬라이더 |
| 7 | **폴더 열기** | 📁 아이콘 (녹화 저장 위치 열기) |
| 8 | **다크/라이트 모드** | 🌙 토글 |
| 9 | **설정** | ⚙️ 톱니바퀴 아이콘 (설정 다이얼로그 열기) |

### 왼쪽 비디오 영역 (~75%)
- 16분할 멀티뷰 영상 표시 (1920×1080 원본 비율 유지)
- 입력 없을 때: "NO SIGNAL INPUT" + 아이콘 표시
- 감지영역 오버레이 (👁 눈 아이콘으로 ON/OFF):
  - 빨간색 적당히 굵은 테두리로 표시
  - **정상 시: 테두리만 표시 (색상 강조 없음)**
  - **이상 발생 시: 해당 영역 빨간 네모 깜빡임**
- 소스 라벨 없음, LIVE 인디케이터 없음, 상태 점 없음

### 오른쪽 로그 영역 (~25%)
- **SYSTEM LOG** 헤더 + 상태 인디케이터 (● 에러있으면 빨간색 / ● 평소 비활성)
- 시간순 로그 (최신이 위)
- **에러 로그: 빨간 배경**
- **정상 로그: 기본 배경 (색상 강조 없음)**
- 세로 스크롤

### 색상 원칙 (전체 프로그램 적용)
> **정상 = 색 표현 없음 (기본 배경/텍스트)**
> **이상 = 빨간색으로만 표시**

- 기본 다크 모드 배경: #1a1a2e 계열
- 기본 텍스트: #e0e0e0
- 에러/이상: #8b0000 ~ #ff4444 계열 (빨간색)
- 정상 상태에 초록색 등 색상 사용 금지

---

## 4. 설정 다이얼로그

### 탭 구조 (4개)
1. **입력/소스**
2. **감지영역 + 감지설정** (영상 + 오디오레벨미터 + 임베디드오디오 통합)
3. **알림설정**
4. **저장/불러오기**

> ※ 스냅샷 탭: 삭제
> ※ 녹화설정: 2차 개발로 이동

### 공통 UI 규칙
- 모든 입력창의 위아래(스핀) 버튼 제거
- 모든 옵션박스는 입력되는 글자크기에 맞게 최소로 조정

---

### 탭 1: 입력/소스

**제거 항목:**
- 소스종류 드롭다운
- 파일경로
- 자동연결(재시도) 항목 모두
- 입력장비 검색 버튼
- 소스 변경 적용 버튼

**UI 구성:**
```
┌─────────────────────────────────────┐
│ 입력 소스                           │
│                                     │
│  포트번호: [0 ▼]                    │
│                                     │
│  ※ 0~5 고정 선택                    │
│  ※ 선택 즉시 자동 적용 (버튼 없음)  │
└─────────────────────────────────────┘
```

- **포트번호**: 드롭다운(콤보박스), 0~5 고정값
- 포트 선택 시 즉시 소스 변경 적용 (별도 버튼 없음)

---

### 탭 2: 감지영역 + 감지설정 (통합 탭)

> **용어**: ROI → 감지영역

이 탭에 **감지영역 설정**, **블랙/스틸 감지**, **오디오 레벨미터 감지**, **임베디드 오디오 감지** 설정을 모두 포함한다.

---

#### 2-1. 감지영역 설정

**편집 방식: 홈화면 활용 + 전체화면 옵션**

설정 다이얼로그 내부의 작은 프리뷰는 정밀 드래그가 어려우므로,
**홈화면 비디오 영역을 직접 편집 캔버스로 활용**한다.

```
┌──────────────────────────────────────────────────────────┐
│  감지영역 설정                                            │
│                                                          │
│  [📐 편집 모드 진입]  [🖥 전체화면 편집]                    │
│                                                          │
│  ※ 편집 모드: 홈화면 비디오 영역(~75%)에서 직접 드래그     │
│  ※ 전체화면: 모니터 전체를 편집 캔버스로 사용              │
│  ※ 편집 중 영상 자동 정지 (정확한 영역 지정)              │
│                                                          │
│  ── 영상 감지영역 ──────────────────────────────────────  │
│  ┌──┬──────┬──────┬────┬────┬────┬────┬──────┐           │
│  │  │ 라벨 │매체명│ X  │ Y  │ W  │ H  │ 관리 │           │
│  ├──┼──────┼──────┼────┼────┼────┼────┼──────┤           │
│  │1 │ V1   │      │ 0  │ 0  │480 │270 │ 📋🗑 │           │
│  │2 │ V2   │      │480 │ 0  │480 │270 │ 📋🗑 │           │
│  └──┴──────┴──────┴────┴────┴────┴────┴──────┘           │
│                                                          │
│  ── 오디오 레벨미터 감지영역 ────────────────────────────  │
│  ┌──┬──────┬──────┬────┬────┬────┬────┬──────┐           │
│  │  │ 라벨 │매체명│ X  │ Y  │ W  │ H  │ 관리 │           │
│  ├──┼──────┼──────┼────┼────┼────┼────┼──────┤           │
│  │1 │ A1   │      │ 0  │ 0  │ 25 │270 │ 📋🗑 │           │
│  └──┴──────┴──────┴────┴────┴────┴────┴──────┘           │
│                                                          │
│  📋 = 복사 (빠른 감지영역 추가)                             │
│  🗑 = 삭제 (직관적 아이콘)                                 │
└──────────────────────────────────────────────────────────┘
```

**편집 모드 동작:**

| 모드 | 설명 |
|------|------|
| **홈화면 편집 모드** | `[📐 편집 모드 진입]` → 설정창 오른쪽 축소(테이블만) → 홈화면 비디오 영역 전체가 편집 캔버스 → 비디오 자동 정지 → 드래그로 영역 설정 → `[편집 완료]`로 복귀 |
| **전체화면 편집 모드** | `[🖥 전체화면 편집]` → 모니터 전체가 편집 캔버스 + 우측 떠있는 테이블 패널 → `ESC` 또는 `[편집 완료]`로 복귀 |

**마우스 조작:**
- 빈 영역 드래그 → 새 감지영역 추가 (테이블에 자동 행 추가)
- 기존 영역 클릭+드래그 → 위치 이동
- 기존 영역 모서리/변 드래그 → 크기 조절

**키보드 조작 (감지영역 선택 상태에서):**

| 키 | 동작 |
|----|------|
| 방향키 | 이동 (10px) |
| Shift + 방향키 | 미세 이동 (1px) |
| Ctrl + 방향키 | 좌상단 기준 크기 조절 (10px) |
| Ctrl + Shift + 방향키 | 좌상단 기준 미세 크기 조절 (1px) |
| Delete | 선택된 감지영역 삭제 |

**감지영역 표시:**
- 빨간색 적당히 굵은 선으로 표시
- 선택된 영역은 흰색 핸들(모서리/변 중간) 표시

**테이블 분리:**
- **영상 감지영역 테이블**: V1, V2, V3... (라벨, 매체명, X, Y, W, H, 관리)
- **오디오 레벨미터 감지영역 테이블**: A1, A2, A3... (라벨, 매체명, X, Y, W, H, 관리)
- 각 테이블은 명확한 구분선/헤더로 분리

---

#### 2-2. 감지설정

3개 섹션으로 명확히 구분하여 표시한다.

```
┌──────────────────────────────────────────────────────────┐
│                                                          │
│  ━━ 1. 블랙/스틸 감지 ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━  │
│                                                          │
│  [블랙 감지]                                              │
│  밝기 임계값: [10]  (0~255, 낮을수록 어두운 것만 감지)      │
│  몇 초 이상시 알림 발생: [10] 초                           │
│                                                          │
│  [스틸 감지]                                              │
│  스틸 임계값: [2]  (0~255, 프레임간 픽셀차이 합산 평균,     │
│                     낮을수록 민감)                         │
│  몇 초 이상시 알림 발생: [10] 초                           │
│                                                          │
│  ━━ 2. 오디오 레벨미터 감지 (HSV) ━━━━━━━━━━━━━━━━━━━━━  │
│                                                          │
│  H: ├──●════════●──┤  40 ~ 80                           │
│  S: ├──●════════●──┤  30 ~ 100                          │
│  V: ├──●════════●──┤  30 ~ 100                          │
│  (듀얼 슬라이더: 하한~상한을 하나의 슬라이더로 조작)        │
│                                                          │
│  몇 초 무음시 알림 발생: [5] 초                            │
│  감지 주기: [0.5] 초  (레벨미터 색상을 확인하는 간격)       │
│                                                          │
│  ━━ 3. 임베디드 오디오 감지 ━━━━━━━━━━━━━━━━━━━━━━━━━━━  │
│                                                          │
│  몇 초 무음시 알림 발생: [10] 초                           │
│  감지 주기: [1.0] 초  (오디오 스트림 레벨을 확인하는 간격)   │
│                                                          │
└──────────────────────────────────────────────────────────┘
```

---

### 탭 3: 알림설정

```
┌──────────────────────────────────────────────────────────┐
│  알림설정                                                │
│                                                          │
│  [시각 알람]                                              │
│  ※ 이상 발생 시 해당 감지영역 빨간 네모 깜빡임             │
│    에러 해소 시 자동 중지 (설정 불필요)                     │
│                                                          │
│  [소리 알람]                                              │
│  ※ 홈화면 상단 바의 🔔 아이콘으로 ON/OFF 및 볼륨 제어      │
│                                                          │
│  [알림 소리 파일]                                         │
│  [📂 알림 소리 폴더 열기]                                  │
│                                                          │
│  파일 규칙:                                               │
│  • 위치: resources/sounds/ 폴더                           │
│  • 파일명: alarm.wav (기본 알림음)                         │
│  • 형식: .wav 파일만 지원                                  │
│  • 사용자 교체: 같은 파일명으로 교체하면 자동 적용          │
│  • 추가 알림음: black_alarm.wav, still_alarm.wav,         │
│    audio_alarm.wav 파일이 있으면 유형별 다른 소리 사용      │
│    (없으면 alarm.wav가 모든 유형에 사용됨)                  │
│                                                          │
│  (2차 개발 예정: 카카오톡 알림)                            │
└──────────────────────────────────────────────────────────┘
```

---

### 탭 4: 저장/불러오기

```
┌──────────────────────────────────────────────────────────┐
│  설정 저장/불러오기                                       │
│                                                          │
│  파일명: [kbs_config] .json   [현재설정저장] [불러오기]    │
│                                                          │
│  ※ 저장 항목: 포트번호, 감지영역(영상+오디오레벨미터),     │
│    감지 파라미터(블랙/스틸/HSV/임베디드오디오),             │
│    알림설정 등 모든 설정                                   │
│  ※ 저장/불러오기 완료 시 팝업으로 성공 알림                │
│  ※ 프로그램 시작 시 마지막 설정 자동 로드                  │
└──────────────────────────────────────────────────────────┘
```

---

## 5. 파일 구조

```
kbs_monitor/
├── main.py                  # 프로그램 시작점
├── requirements.txt         # 의존성
├── config/
│   └── default_config.json  # 기본 설정
│
├── ui/                      # UI 관련
│   ├── __init__.py
│   ├── main_window.py       # 메인 윈도우 (3분할 레이아웃)
│   ├── top_bar.py           # 상단 바 위젯
│   ├── video_widget.py      # 비디오 표시 위젯
│   ├── log_widget.py        # 시스템 로그 위젯
│   ├── settings_dialog.py   # 설정 다이얼로그 (4개 탭)
│   ├── roi_editor.py        # 감지영역 편집기 (홈화면/전체화면 모드)
│   └── dual_slider.py       # HSV 듀얼 슬라이더 위젯
│
├── core/                    # 핵심 로직
│   ├── __init__.py
│   ├── video_capture.py     # 비디오 캡처 (OpenCV)
│   ├── audio_monitor.py     # 실제 오디오 모니터링 (sounddevice)
│   ├── roi_manager.py       # 감지영역 관리
│   ├── detector.py          # 감지 엔진 (블랙/스틸/레벨미터/임베디드오디오)
│   └── alarm.py             # 알람 시스템 (시각+소리)
│
├── utils/                   # 유틸리티
│   ├── __init__.py
│   ├── config_manager.py    # 설정 저장/로드
│   └── logger.py            # 로깅
│
└── resources/               # 리소스
    ├── sounds/
    │   └── alarm.wav         # 기본 알람 소리
    └── styles/
        └── dark_theme.qss   # 다크 모드 스타일시트
```

---

## 6. 페이즈별 개발 계획

### Phase 1: 프로젝트 골격 + 영상 입력 + 메인 화면

**목표:** 프로그램 실행 시 16분할 영상이 표시되는 기본 화면 완성

**구현 내용:**
1. 프로젝트 폴더 구조 생성 + requirements.txt
2. main.py 진입점
3. main_window.py: 3분할 레이아웃 (상단바 + 비디오 + 로그)
4. top_bar.py: 상단 바 전체 구현
   - Monitoring Active 토글
   - 현재 시각 (HH:MM:SS)
   - 오디오: 스피커 아이콘(뮤트) + 볼륨 슬라이더 + L/R 레벨미터
   - 감지현황: V0 A0 EA (초기 상태)
   - 👁 감지영역 보이기 아이콘
   - 🔔 소리 알람 아이콘 + 볼륨 슬라이더
   - 📁 폴더 열기 아이콘
   - 🌙 다크/라이트 모드 토글
   - ⚙️ 설정 아이콘
5. video_widget.py: OpenCV 캡처 → QLabel 표시, "NO SIGNAL INPUT" 상태
6. log_widget.py: 시간순 로그, 에러=빨간배경, 정상=기본배경(색 강조 없음)
7. audio_monitor.py: sounddevice로 임베디드 오디오 캡처, L/R 레벨 실시간 표시
8. dark_theme.qss: 다크 모드 스타일 (정상=색없음, 이상=빨간색)
9. 설정 다이얼로그 껍데기 (탭 1: 입력/소스만 구현)
   - 포트번호 드롭다운 (0~5), 선택 즉시 적용
10. config_manager.py: JSON 설정 저장/로드 기본 구조

**완료 기준:**
- 프로그램 실행 → 캡처 카드 영상 표시 (또는 NO SIGNAL)
- 상단 바의 모든 요소 표시 및 작동
- 로그 영역에 시스템 시작 로그 표시
- 포트번호 선택 시 즉시 소스 변경

**체크포인트 파일:** `PHASE1_COMPLETE.md` 생성

---

### Phase 2: 감지영역 설정 + 블랙/스틸 감지

**목표:** 홈화면/전체화면에서 마우스+키보드로 감지영역 설정, 블랙/스틸 실시간 감지

**구현 내용:**
1. roi_editor.py: 감지영역 편집기
   - **홈화면 편집 모드**: 설정창 축소 → 비디오 영역이 편집 캔버스
   - **전체화면 편집 모드**: 모니터 전체가 편집 캔버스 + 떠있는 테이블 패널
   - 편집 진입 시 비디오 자동 정지
   - 마우스: 드래그 추가 / 클릭+드래그 이동 / 모서리 드래그 크기조절
   - 키보드: 방향키(10px), Shift+방향키(1px), Ctrl+방향키(크기10px), Ctrl+Shift+방향키(크기1px), Delete
   - 복사(📋) / 삭제(🗑) 아이콘 버튼
   - 영상/오디오 레벨미터 감지영역 테이블 분리
2. roi_manager.py: 감지영역 데이터 관리
3. detector.py: 블랙 감지 + 스틸 감지 엔진
   - 블랙: 영역 내 평균 밝기 < 밝기 임계값 → 지속시간 체크
   - 스틸: 이전 프레임과 차이값 < 스틸 임계값 → 지속시간 체크
4. alarm.py: 시각적 알람 (감지영역 빨간 네모 깜빡임) + 소리 알람
5. 설정 다이얼로그 탭 2: 감지영역 + 감지설정 통합 탭
   - 블랙/스틸 파라미터 설정 UI (섹션 1)
6. 감지 상태를 로그에 기록
7. 상단 바 감지현황 업데이트 (V16 A0 EA)
8. 상단 바 🔔 소리 알람 ON/OFF + 볼륨 동작 구현

**완료 기준:**
- 홈화면/전체화면 편집 모드에서 마우스+키보드로 감지영역 설정 가능
- 블랙/스틸 감지 시 빨간 네모 깜빡임 + 로그 기록
- 감지 파라미터 변경 가능
- 알람 소리 ON/OFF + 볼륨 조절

**체크포인트 파일:** `PHASE2_COMPLETE.md` 생성

---

### Phase 3: 오디오 레벨미터 감지 + 임베디드 오디오 감지

**목표:** HSV 기반 레벨미터 감지 + 임베디드 오디오 무음/끊김 감지

**구현 내용:**
1. detector.py 확장: 오디오 레벨미터 HSV 감지 (섹션 2)
   - 감지영역 내 HSV 범위 픽셀 비율 계산
   - 초록색 0% = 무음 판정
2. detector.py 확장: 임베디드 오디오 감지 (섹션 3)
   - sounddevice 스트림 레벨 분석
   - 무음 감지 + 스트림 끊김 감지
3. dual_slider.py: HSV 듀얼 슬라이더 커스텀 위젯
4. 설정 다이얼로그: 오디오 레벨미터 HSV 설정 + 임베디드 오디오 설정
5. 감지현황 업데이트: V16 A16 EA

**완료 기준:**
- 레벨미터 감지영역 설정 가능 (마우스 드래그)
- HSV 듀얼 슬라이더로 색상 범위 조절
- 레벨미터 무음 감지 시 알람 발동
- 임베디드 오디오 무음/끊김 감지 시 알람 발동

**체크포인트 파일:** `PHASE3_COMPLETE.md` 생성

---

### Phase 4: 설정 저장/불러오기 + 알림 완성 + 마무리

**목표:** 전체 설정 영속성 확보, 안정성 검증

**구현 내용:**
1. config_manager.py 완성: 모든 설정 JSON 저장/로드
   - 포트번호, 감지영역(영상+오디오), 감지 파라미터 전체, 알림설정
   - 프로그램 시작 시 마지막 설정 자동 로드
   - 저장/불러오기 완료 시 팝업
2. 설정 다이얼로그 탭 3: 알림설정
   - 알림 소리 폴더 열기 버튼 + 파일 규칙 설명
3. 설정 다이얼로그 탭 4: 저장/불러오기
   - `[현재설정저장]` + `[불러오기]` 버튼 작게 나란히
4. 전체 UI 일관성 점검
   - 모든 위아래(스핀) 버튼 제거 확인
   - 옵션박스 최소 크기 확인
   - 정상=색없음, 이상=빨간색 원칙 확인
5. 24/7 안정성: 예외 처리, 메모리 관리
6. 최종 테스트 및 버그 수정

**완료 기준:**
- 설정 저장 → 프로그램 재시작 → 설정 복원 정상
- 장시간 운영 시 메모리 누수 없음
- 모든 UI 요소 정상 작동

**체크포인트 파일:** `PHASE4_COMPLETE.md` 생성

---

## 7. Claude Code 설정

### 7-1. 프로젝트 초기 설정 파일들

#### `.claude/settings.json`
```json
{
  "model": "sonnet",
  "language": "korean"
}
```

> **모델 고정**: `"model": "sonnet"` → Sonnet 4.5 고정
> **언어 설정**: `"language": "korean"` → 한국어로 대화

#### `CLAUDE.md` (프로젝트 루트)
```markdown
# KBS 16채널 비디오 모니터링 시스템 v2

## 프로젝트 개요
- PySide6 기반 16채널 비디오 모니터링 시스템
- 블랙/스틸/오디오레벨미터/임베디드오디오 감지 + 시각/소리 알림
- Python 3.10+

## 개발 규칙
- 모든 응답은 한국어로 작성
- PySide6 사용 (PyQt 아님)
- 다크 모드 UI 기본
- 색상 원칙: 정상=색 표현 없음, 이상=빨간색만 사용 (초록색 금지)
- 파일 인코딩: UTF-8
- 들여쓰기: 4 spaces
- docstring: 한국어
- QSpinBox 위아래 버튼 사용 금지

## 용어
- ROI → "감지영역"으로 통일
- 탭 구조: 입력/소스, 감지영역+감지설정, 알림설정, 저장/불러오기
- 감지현황 표기: V(영상) A(오디오레벨미터) EA(임베디드오디오)

## 현재 개발 상태
- 체크포인트 파일(PHASE*_COMPLETE.md)을 확인하여 현재 진행 상황 파악
- 체크포인트가 없으면 Phase 1부터 시작
- 각 Phase 완료 시 PHASE{N}_COMPLETE.md 파일 생성

## 주의사항
- 스냅샷 탭 없음, 녹화설정 탭 없음 (2차 개발)
- 카카오톡/이메일 없음 (2차 개발)
- 성능설정 없음 (감지영역 최대 500×250, 개수 최대 각 16개)
- 비디오 영역에 소스 라벨, LIVE 인디케이터, 상태 점 없음
```

### 7-2. 서브에이전트

**사용하지 않음** — Pro 요금제에서 토큰 소비가 급격히 증가하므로 단일 에이전트 + CLAUDE.md로 충분

### 7-3. 토큰 소진 대비 전략

**체크포인트 시스템:**
1. 각 Phase 완료 시 `PHASE{N}_COMPLETE.md` 자동 생성
2. 파일 내용: 완료 작업 목록, 다음 할 일, 현재 파일 상태
3. 새 세션에서 이 계획서 + CLAUDE.md 전달 → 중단 지점부터 재개

**Phase 내부 중단 시:**
- 각 파일 단위로 커밋하므로 어떤 파일까지 완성되었는지 확인 가능
- 재개 프롬프트:
  ```
  이 프로젝트의 CLAUDE.md를 읽고, PHASE*_COMPLETE.md 파일을 확인해서
  현재 진행 상태를 파악한 후 이어서 개발해줘.
  ```

---

## 8. Claude Code 실행 프롬프트

### Phase 1 실행 시
```
KBS 16채널 비디오 모니터링 시스템을 만들어줘.

전체 계획서는 KBS_16CH_모니터링_v2_개발계획서.md 에 있어.
먼저 계획서를 읽고 Phase 1부터 시작해.

시작 전에:
1. 프로젝트 폴더 구조 생성
2. CLAUDE.md 생성
3. .claude/settings.json 생성 (model: sonnet, language: korean)
4. Phase 1 구현 시작

완료 후 PHASE1_COMPLETE.md 생성해서 완료 상태 기록.
```

### 중단 후 재개 시
```
이 프로젝트의 CLAUDE.md를 읽고, PHASE*_COMPLETE.md 파일을 확인해서
현재 진행 상태를 파악해줘.
확인 후 중단된 지점부터 이어서 개발해줘.
계획서는 KBS_16CH_모니터링_v2_개발계획서.md에 있어.
```

### 다음 Phase 시작 시
```
Phase {N} 완료. 계획서 참고해서 Phase {N+1} 시작해줘.
완료 후 PHASE{N+1}_COMPLETE.md 생성.
```

---

## 9. 로그 형식

```
에러 (빨간 배경):
19:34:07 - SYSTEM - Connection Failed - Attempting fallback for camera #0
14:23:15 - V3(1DTV N/P) - 블랙 감지 5초 지속

정상 (기본 배경, 색상 강조 없음):
19:33:57 - SYSTEM - Program Started Successfully
14:25:30 - V3(1DTV N/P) - 정상 복구
19:25:01 - NETWORK - Latency check: 12ms (Stable)
```

---

## 10. 핵심 구현 포인트

### 10-1. 감지 엔진 (detector.py)
```
블랙 감지:
- 감지영역 내 모든 픽셀의 평균 밝기 계산
- 평균 밝기 < 밝기 임계값(기본 10) → 블랙 상태
- 블랙 상태 N초(기본 10초) 이상 지속 → 알람

스틸 감지:
- 현재/이전 프레임의 감지영역 픽셀 차이 합산 평균
- 차이값 < 스틸 임계값(기본 2) → 스틸 상태
- 스틸 상태 N초(기본 10초) 이상 지속 → 알람

오디오 레벨미터 감지 (Phase 3):
- 감지영역 내 HSV 범위 픽셀 비율 계산
- 초록색 0% = 무음 → N초(기본 5초) 이상 → 알람

임베디드 오디오 감지 (Phase 3):
- sounddevice 스트림 레벨 분석
- 무음 N초(기본 10초) 이상 → 알람
```

### 10-2. 멀티스레딩 구조
```
메인 스레드: PySide6 UI
├── 비디오 캡처 스레드: OpenCV 프레임 읽기
├── 감지 스레드: 블랙/스틸/레벨미터 분석
├── 오디오 스레드: sounddevice 레벨 모니터링
└── 알람 스레드: 소리 재생
```

### 10-3. 알람 동작
- **시각 알람**: 이상 감지 시 해당 감지영역 빨간 네모 깜빡임, 에러 해소 시 자동 중지
- **소리 알람**: 🔔 아이콘 ON일 때 alarm.wav 재생, 유형별 파일 있으면 분리 재생
- **정상 시 아무 표시 없음** (초록색 등 색상 강조 없음)

### 10-4. 성능
- 감지영역 최대 크기: 500×250 이하
- 영상/오디오 감지 각 최대 16개
- 영상 감지 주기: 매 프레임 (30fps)
- 레벨미터 감지 주기: 0.5초 (설정 가능)
- 임베디드 오디오 감지 주기: 1.0초 (설정 가능)

---

## 11. 실제 구현 현황 (최종)

> 계획 대비 실제 구현된 내용을 기록합니다. 추후 동일한 프로그램을 재현할 때 참고용입니다.

### 11-1. 계획 대비 변경된 탭 구조

| 계획 탭명 | 실제 구현 탭명 | 변경 이유 |
|-----------|--------------|----------|
| 입력/소스 | 입력선택 | 명칭 단순화 |
| 감지영역 + 감지설정 (통합) | 탭 2: 비디오 감지 설정 / 탭 3: 오디오 레벨미터 감지 설정 / 탭 4: 감지 설정 | 내용이 많아 분리. 탭 2·3은 ROI 편집, 탭 4는 파라미터 전용 |
| 알림설정 | 알림설정 | 동일 |
| 저장/불러오기 | 저장/불러오기 | 동일 |

> **결과**: 계획 4탭 → 실제 6탭 구조로 확장됨

### 11-2. 계획 대비 추가/변경된 기능

| 구분 | 계획 | 실제 구현 |
|------|------|----------|
| 감지 On/Off | TopBar 토글 버튼 | **제거** — 항상 감지 활성으로 변경 |
| 시스템 성능 표시 | 없음 | **추가** — TopBar SysMonitorWidget (CPU/RAM/GPU% 실시간) |
| 성능 설정 | 없음 | **추가** — 탭 4에 감지 주기/해상도/감지 활성화 체크박스 |
| 벤치마크 자동 측정 | 없음 | **추가** — [PC 성능 자동 측정] 버튼으로 최적 파라미터 자동 결정 |
| 영상 파일 소스 | 없음 | **추가** — 탭 1에 MP4 파일 소스 옵션 (테스트용) |
| 알림 복구 딜레이 | 없음 | **추가** — 오디오 레벨미터 복구 딜레이 파라미터 |
| ROI 다중 선택 | 없음 | **추가** — Ctrl+클릭 다중 선택, Shift+드래그 고무줄 선택, 다중 이동/Ctrl+복사 |
| 라이트/다크 테마 | 다크 모드만 | **추가** — 라이트 모드 QSS + 런타임 전환 |

### 11-3. 실제 구현된 아키텍처

```
[메인 스레드 (PySide6 UI)]
├── VideoCaptureThread (QThread)
│     └── OpenCV CAP_DSHOW → frame_ready(numpy BGR) → MainWindow._on_frame_ready
├── AudioMonitorThread (QThread)
│     └── sounddevice RawInputStream → level_updated(L_dB, R_dB)
│                                    → silence_detected(seconds)
├── QTimer(200ms 기본) → _run_detection()
│     ├── Detector.detect_frame(frame, video_rois) → 블랙/스틸 결과
│     │     └── scale_factor 축소 → ROI crop → 밝기/차이 분석 → DetectionState 업데이트
│     └── Detector.detect_audio_roi(frame, audio_rois) → 레벨미터 결과
│           └── BGR→HSV crop → inRange → 픽셀비율 이동평균 → DetectionState 업데이트
├── QTimer(1000ms) → _update_summary() → TopBar.update_summary(V수, A수, EA상태)
└── AlarmSystem (QObject)
      ├── visual_blink Signal(0.5초 토글) → VideoWidget.set_blink_state
      └── 사운드 스레드 (daemon) → winsound/sounddevice WAV 재생
```

### 11-4. 설정 파일 구조 (JSON)

```json
{
  "port": 0,
  "rois": {
    "video": [{"label":"V1","media_name":"","x":0,"y":0,"w":100,"h":100,"roi_type":"video"}],
    "audio": [{"label":"A1","media_name":"","x":0,"y":0,"w":100,"h":100,"roi_type":"audio"}]
  },
  "detection": {
    "black_threshold": 10,
    "black_duration": 10,
    "black_alarm_duration": 10,
    "still_threshold": 2,
    "still_duration": 10,
    "still_alarm_duration": 10,
    "audio_hsv_h_min": 40, "audio_hsv_h_max": 80,
    "audio_hsv_s_min": 30, "audio_hsv_s_max": 255,
    "audio_hsv_v_min": 30, "audio_hsv_v_max": 255,
    "audio_pixel_ratio": 5,
    "audio_level_duration": 5,
    "audio_level_alarm_duration": 10,
    "audio_level_recovery_seconds": 2,
    "embedded_silence_threshold": -50,
    "embedded_silence_duration": 10,
    "embedded_alarm_duration": 10
  },
  "performance": {
    "detection_interval": 200,
    "scale_factor": 1.0,
    "video_detection_enabled": true,
    "audio_detection_enabled": true,
    "still_detection_enabled": true
  },
  "alarm": {
    "sound_enabled": true,
    "volume": 80,
    "sound_files": {
      "black": "", "still": "", "audio": "", "default": ""
    }
  }
}
```

### 11-5. 주요 클래스/메서드 목록

#### core/detector.py — `DetectionState`

| 속성/메서드 | 역할 |
|------------|------|
| `is_alerting` | 현재 알림 발생 중 여부 |
| `alert_duration` | 이상 지속 시간(초) |
| `just_resolved` | 이번 업데이트에서 정상 복구됨 여부 |
| `last_alert_duration` | 직전 알림 지속 시간 (로그용) |
| `update(is_abnormal, threshold, recovery)` | 상태 업데이트, alerting 반환 |

#### core/detector.py — `Detector`

| 메서드 | 역할 |
|--------|------|
| `_apply_scale_factor(frame)` | scale_factor 적용 공통 처리 |
| `update_roi_list(rois)` | ROI 목록 변경 시 상태/버퍼 동기화 |
| `detect_frame(frame, rois)` | 블랙/스틸 감지, label별 결과 dict 반환 |
| `detect_audio_roi(frame, rois)` | HSV 레벨미터 감지, label별 결과 dict 반환 |
| `update_embedded_silence(seconds)` | 임베디드 무음 상태 업데이트 |
| `reset_all()` | 전체 상태 초기화 |

#### ui/roi_editor.py — `ROIEditorCanvas`

| 기능 | 구현 방식 |
|------|----------|
| 새 영역 추가 | 빈 곳 마우스 드래그 |
| 이동 | ROI 몸통 클릭+드래그 |
| 크기 조절 | 8방향 핸들 드래그 |
| 다중 선택 | Ctrl+클릭, Shift+고무줄 드래그 |
| 다중 이동 | 다중 선택 후 드래그 |
| Ctrl+복사 | Ctrl+드래그로 선택 ROI 복제 |
| 키보드 | 방향키/Shift+방향키/Ctrl+방향키 |
| 좌표 변환 | 레터박스 고려 위젯↔프레임 좌표 변환 |

### 11-6. 개발 기간 및 페이즈 요약

| 페이즈 | 완료일 | 주요 내용 |
|--------|--------|----------|
| Phase 1 | 2026-02-18 | 프로젝트 골격, 비디오 캡처, 오디오 스레드, 기본 UI |
| Phase 2 | 2026-02-18 | ROI 편집기, 블랙/스틸 감지, 설정 다이얼로그 탭 1~4 기초 |
| Phase 3 | 2026-02-19 | HSV 레벨미터 감지, 임베디드 오디오 감지, DualSlider |
| Phase 4 | 2026-02-20 | 알림설정 탭, 저장/불러오기 탭, 알림음 파일 개별 설정 |
| Phase 5 | 2026-02-21 | 코드 최적화 (메모리 누수 수정, DRY화, 성능 개선) |

### 11-7. 재현 시 유의사항

1. **설정 다이얼로그 비모달**: `QDialog`를 `show()` 로 열고 ROI 편집 오버레이와 공존
2. **반화면 ROI 편집**: `ROIEditorCanvas`를 `VideoWidget` 위에 오버레이로 표시, 편집 중 감지 타이머 중단
3. **신호 흐름 핵심**: `_run_detection()`은 `_latest_frame`(마지막 수신 프레임)만 분석. 프레임 큐 없음
4. **오디오 ROI 색상**: 파란색 계열 (BGR 200,120,0) — CLAUDE.md 초록 금지 원칙 적용
5. **임베디드 오디오 복구**: `level_updated` 시그널의 평균 dB로 무음 해제 판정 (`silence_detected` 신호 미수신 시 복구)
6. **스케일 팩터 적용**: `detect_frame()` / `detect_audio_roi()` 둘 다 동일한 `_apply_scale_factor()` 호출, ROI 좌표에 `sf` 곱하여 보정
